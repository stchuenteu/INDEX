
---BACKUP JOBS WITH PREFERENCES AlwaysON

DECLARE @preferredReplica int
SET @preferredReplica = (SELECT [master].sys.fn_hadr_backup_is_preferred_replica('DBName'))
IF (@preferredReplica = 1)
BEGIN
    BACKUP DATABASE [DBName] TO  DISK = N'Disk Name'
	WITH NOFORMAT, INIT,    SKIP, REWIND,NOUNLOAD,COMPRESSION,  STATS = 10
END
GO


-------------0  Fix ORPHEN SUSERS   --------------------

use [DBName]
go

DECLARE @username varchar(25)
DECLARE fixusers CURSOR 
FOR
SELECT UserName = name FROM sysusers
WHERE issqluser = 1 and (sid is not null and sid <> 0x0)
and suser_sname(sid) is null
ORDER BY name

OPEN fixusers

FETCH NEXT FROM fixusers
INTO @username
WHILE @@FETCH_STATUS = 0
BEGIN
IF @username='dbo'
BEGIN 
EXEC sp_changedbowner 'sa'
END
ELSE
BEGIN
EXEC sp_change_users_login 'update_one', @username, @username
END
FETCH NEXT FROM fixusers
INTO @username
END
CLOSE fixusers
DEALLOCATE fixusers





-------------BRING LOGSHIPPING ONLINE   -----------------------------

----Backup jobs
EXEC MSDB..sp_start_job @job_name = 'LSBackup_FLXLKP'                                     --Backup jobs Name from source server



---Copy jobs
EXEC MSDB..sp_start_job @job_name = 'LSCopy_MISDB004CMITC1\MISDB004CMITC1_FLXLKP'        -- 'LSCopy_MISDB004CMITC1\MISDB004CMITC1_FLXLKP' is copy jobs Name from Target server


--Restore jobs
EXEC MSDB..sp_start_job @job_name = 'LSRestore_MISDB004CMITC1\MISDB004CMITC1_FLXLKP'    -- 'LSRestore_MISDB004CMITC1\MISDB004CMITC1_FLXLKP' restore jobs Name from Target server














